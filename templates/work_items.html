{% extends "base.html" %}

{% block title %}Work Items - Magellan EV Tracker{% endblock %}

{% block page_title %}Work Items{% endblock %}

{% block header_actions %}
<a href="{{ url_for('main.add_work_item') }}" class="btn btn-primary">
    <i class="fas fa-plus"></i> Add Work Item
</a>
{% endblock %}

{% block content %}
<!-- Project Selection -->
<div class="filter-container mb-3">
    <form method="GET" action="{{ url_for('main.work_items') }}">
        <div class="row align-items-center">
            <div class="col-md-4">
                <label class="form-label">Project</label>
                <select class="form-select" name="project_id" id="project-select">
                    <option value="">All Projects</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}" {% if selected_project_id == project.id %}selected{% endif %}>
                        {{ project.project_id_str }}: {{ project.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Sub Job</label>
                <select class="form-select" name="sub_job_id" id="subjob-select">
                    <option value="">All Sub Jobs</option>
                    {% for sub_job in sub_jobs %}
                    <option value="{{ sub_job.id }}" {% if selected_sub_job_id == sub_job.id %}selected{% endif %}>
                        {{ sub_job.sub_job_id_str }}: {{ sub_job.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-outline-light w-100">Apply Selection</button>
            </div>
        </div>
    </form>
</div>

<!-- Filters -->
<div class="filter-container">
    <form method="GET" action="{{ url_for('main.work_items') }}" id="filter-form">
        <input type="hidden" name="project_id" value="{{ selected_project_id }}">
        <input type="hidden" name="sub_job_id" value="{{ selected_sub_job_id }}">
        <div class="row g-3">
            <div class="col-md-3">
                <input type="text" class="form-control" name="search" placeholder="Search work items..." value="{{ search_query }}">
            </div>
            <div class="col-md-3">
                <select class="form-select" name="cost_code_id">
                    <option value="">All Cost Codes</option>
                    {% for cost_code in cost_codes %}
                    <option value="{{ cost_code.id }}" {% if selected_cost_code_id == cost_code.id %}selected{% endif %}>
                        {{ cost_code.cost_code_id_str }}: {{ cost_code.description }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" name="status">
                    <option value="">All Status</option>
                    <option value="not_started" {% if status == 'not_started' %}selected{% endif %}>Not Started</option>
                    <option value="in_progress" {% if status == 'in_progress' %}selected{% endif %}>In Progress</option>
                    <option value="completed" {% if status == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="on_hold" {% if status == 'on_hold' %}selected{% endif %}>On Hold</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" name="sort_by">
                    <option value="id" {% if sort_by == 'id' %}selected{% endif %}>Work Item ID</option>
                    <option value="description" {% if sort_by == 'description' %}selected{% endif %}>Description</option>
                    <option value="progress" {% if sort_by == 'progress' %}selected{% endif %}>Progress</option>
                    <option value="cost_code" {% if sort_by == 'cost_code' %}selected{% endif %}>Cost Code</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-outline-light w-100">Filter</button>
            </div>
        </div>
    </form>
</div>

<!-- Work Items Table -->
<div class="data-container">
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Work Item ID</th>
                    <th>Description</th>
                    <th>Cost Code</th>
                    <th>Budgeted Hours</th>
                    <th>Earned Hours</th>
                    <th>Progress</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for work_item in work_items %}
                <tr>
                    <td>{{ work_item.work_item_id_str }}</td>
                    <td>{{ work_item.description }}</td>
                    <td>{{ work_item.cost_code.cost_code_id_str }}</td>
                    <td>{{ work_item.budgeted_man_hours|round(1) }}</td>
                    <td>{{ work_item.earned_man_hours|round(1) }}</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: {{ work_item.percent_complete_hours|round(0) }}%" 
                                aria-valuenow="{{ work_item.percent_complete_hours|round(0) }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="progress-value">{{ work_item.percent_complete_hours|round(0) }}%</div>
                    </td>
                    <td>
                        {% if work_item.percent_complete_hours == 0 %}
                        <span class="badge badge-status badge-not-started">Not Started</span>
                        {% elif work_item.percent_complete_hours == 100 %}
                        <span class="badge badge-status badge-completed">Completed</span>
                        {% elif work_item.percent_complete_hours > 0 %}
                        <span class="badge badge-status badge-in-progress">In Progress</span>
                        {% else %}
                        <span class="badge badge-status badge-on-hold">On Hold</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('main.update_work_item_progress', work_item_id=work_item.id) }}" class="btn btn-sm btn-outline-light me-1" title="Update Progress">
                            <i class="fas fa-chart-line"></i>
                        </a>
                        <a href="{{ url_for('main.edit_work_item', work_item_id=work_item.id) }}" class="btn btn-sm btn-outline-light me-1" title="Edit">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="{{ url_for('main.view_work_item', work_item_id=work_item.id) }}" class="btn btn-sm btn-outline-light" title="View Details">
                            <i class="fas fa-eye"></i>
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center">No work items found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if pagination.pages > 1 %}
    <div class="d-flex justify-content-center mt-4">
        <nav aria-label="Page navigation">
            <ul class="pagination">
                {% if pagination.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('main.work_items', page=pagination.prev_num, project_id=selected_project_id, sub_job_id=selected_sub_job_id, search=search_query, cost_code_id=selected_cost_code_id, status=status, sort_by=sort_by) }}">Previous</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">Previous</span>
                </li>
                {% endif %}
                
                {% for page_num in pagination.iter_pages() %}
                    {% if page_num %}
                        {% if page_num == pagination.page %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% else %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.work_items', page=page_num, project_id=selected_project_id, sub_job_id=selected_sub_job_id, search=search_query, cost_code_id=selected_cost_code_id, status=status, sort_by=sort_by) }}">{{ page_num }}</a>
                        </li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if pagination.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('main.work_items', page=pagination.next_num, project_id=selected_project_id, sub_job_id=selected_sub_job_id, search=search_query, cost_code_id=selected_cost_code_id, status=status, sort_by=sort_by) }}">Next</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">Next</span>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const projectSelect = document.getElementById('project-select');
        const subJobSelect = document.getElementById('subjob-select');
        
        // Update sub jobs when project changes
        projectSelect.addEventListener('change', function() {
            const projectId = this.value;
            
            // Clear current options
            while (subJobSelect.options.length > 1) {
                subJobSelect.remove(1);
            }
            
            if (projectId) {
                // Fetch sub jobs for selected project
                fetch(`/api/project/${projectId}/sub_jobs`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(subJob => {
                            const option = document.createElement('option');
                            option.value = subJob.id;
                            option.textContent = `${subJob.sub_job_id_str}: ${subJob.name}`;
                            subJobSelect.appendChild(option);
                        });
                    });
            }
        });
    });
</script>
{% endblock %}

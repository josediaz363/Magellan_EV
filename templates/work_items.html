{% extends "base.html" %}

{% block title %}Work Items{% endblock %}

{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h1>Work Items</h1>
                
                <!-- Filter Section -->
                <div class="filter-container">
                    <div class="filter-flex-row grid-5">
                        <div class="filter-flex-item">
                            <select class="form-select" id="project-filter">
                                <option value="">All Projects</option>
                                {% for project in projects %}
                                    <option value="{{ project.id }}">{{ project.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="filter-flex-item">
                            <select class="form-select" id="subjob-filter">
                                <option value="">All Sub Jobs</option>
                            </select>
                        </div>
                        <div class="filter-flex-item">
                            <select class="form-select" id="costcode-filter">
                                <option value="">All Cost Codes</option>
                                {% for cost_code in cost_codes %}
                                    <option value="{{ cost_code.id }}">{{ cost_code.code }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="filter-flex-item">
                            <input type="text" class="form-control" id="search-filter" placeholder="Search...">
                        </div>
                        <div class="filter-flex-item">
                            <button id="apply-filters" class="btn btn-primary w-100">Apply Filters</button>
                        </div>
                    </div>
                </div>
                
                <!-- Work Items Table -->
                <div class="data-table">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="title">Work Items</div>
                        <a href="#" class="btn btn-primary">Add Work Item</a>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Project</th>
                                    <th>Sub Job</th>
                                    <th>Cost Code</th>
                                    <th>Progress</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in work_items %}
                                <tr>
                                    <td>{{ item.description }}</td>
                                    <td>{{ item.project.name if item.project else 'N/A' }}</td>
                                    <td>{{ item.sub_job.name if item.sub_job else 'N/A' }}</td>
                                    <td>{{ item.cost_code.code if item.cost_code else 'N/A' }}</td>
                                    <td>{{ item.percent_complete_hours }}%</td>
                                    <td>
                                        <a href="#" class="btn btn-sm btn-outline-light me-1">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="#" class="btn btn-sm btn-outline-light me-1">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="#" class="btn btn-sm btn-outline-light delete-item" data-id="{{ item.id }}">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center">No work items available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const projectFilter = document.getElementById('project-filter');
        const subjobFilter = document.getElementById('subjob-filter');
        const applyFiltersBtn = document.getElementById('apply-filters');
        
        // Update sub jobs when project changes
        projectFilter.addEventListener('change', function() {
            const projectId = this.value;
            
            // Clear current options
            subjobFilter.innerHTML = '<option value="">All Sub Jobs</option>';
            
            if (projectId) {
                // Fetch sub jobs for the selected project
                fetch(`/api/projects/${projectId}/subjobs`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(subjob => {
                            const option = document.createElement('option');
                            option.value = subjob.id;
                            option.textContent = subjob.name;
                            subjobFilter.appendChild(option);
                        });
                    });
            }
        });
        
        // Apply filters
        applyFiltersBtn.addEventListener('click', function() {
            const projectId = projectFilter.value;
            const subjobId = subjobFilter.value;
            const costCodeId = document.getElementById('costcode-filter').value;
            const searchTerm = document.getElementById('search-filter').value;
            
            let url = '?';
            
            if (projectId) url += `project_id=${projectId}&`;
            if (subjobId) url += `sub_job_id=${subjobId}&`;
            if (costCodeId) url += `cost_code_id=${costCodeId}&`;
            if (searchTerm) url += `search=${searchTerm}&`;
            
            // Remove trailing & if exists
            if (url.endsWith('&')) {
                url = url.slice(0, -1);
            }
            
            window.location.href = url;
        });
    });
</script>
{% endblock %}

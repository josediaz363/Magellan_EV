{% extends "base.html" %}

{% block title %}Work Items - Magellan EV Tracker{% endblock %}

{% block content %}
    <div class="navbar">
        <div class="d-flex justify-content-between align-items-center w-100">
            <h2>Work Items</h2>
            <div>
                <a href="{{ url_for('main.add_work_item') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Work Item
                </a>
            </div>
        </div>
    </div>

    <!-- Project Selection -->
    <div class="filter-container mb-3">
        <div class="row align-items-center">
            <div class="col-md-4">
                <label class="form-label">Project</label>
                <select class="form-select" id="projectSelect">
                    <option value="all">All Projects</option>
                    {% for project in projects %}
                        <option value="{{ project.id }}" {% if selected_project_id == project.id %}selected{% endif %}>{{ project.project_id_str }}: {{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Sub Job</label>
                <select class="form-select" id="subJobSelect" {% if not selected_project_id or selected_project_id == 'all' %}disabled{% endif %}>
                    <option value="all">All Sub Jobs</option>
                    {% if selected_project_id and selected_project_id != 'all' %}
                        {% for sub_job in sub_jobs %}
                            <option value="{{ sub_job.id }}" {% if selected_sub_job_id == sub_job.id %}selected{% endif %}>{{ sub_job.sub_job_id_str }}: {{ sub_job.name }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-outline-light w-100" id="applySelection">Apply Selection</button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-container">
        <div class="row g-3">
            <div class="col-md-3">
                <input type="text" class="form-control" id="searchInput" placeholder="Search work items...">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="costCodeFilter">
                    <option value="all">All Cost Codes</option>
                    {% for cost_code in cost_codes %}
                        <option value="{{ cost_code.id }}">{{ cost_code.cost_code_id_str }}: {{ cost_code.description }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="statusFilter">
                    <option value="all">All Status</option>
                    <option value="not_started">Not Started</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="on_hold">On Hold</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="sortBy">
                    <option value="id">Sort By ID</option>
                    <option value="description">Sort By Description</option>
                    <option value="progress">Sort By Progress</option>
                    <option value="cost_code">Sort By Cost Code</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-outline-light w-100" id="applyFilters">Filter</button>
            </div>
        </div>
    </div>

    <!-- Work Items Table -->
    <div class="data-container">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Work Item ID</th>
                        <th>Description</th>
                        <th>Cost Code</th>
                        <th>Budgeted Hours</th>
                        <th>Earned Hours</th>
                        <th>Progress</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="workItemsTableBody">
                    {% if work_items %}
                        {% for item in work_items %}
                            <tr class="work-item-row" 
                                data-id="{{ item.id }}"
                                data-project="{{ item.project_id }}"
                                data-subjob="{{ item.sub_job_id }}"
                                data-costcode="{{ item.cost_code_id }}"
                                data-progress="{{ item.percent_complete_hours|round|int }}"
                                data-status="{{ item.status if item.status else 'not_started' }}">
                                <td>{{ item.work_item_id_str }}</td>
                                <td>{{ item.description }}</td>
                                <td>{{ item.cost_code.cost_code_id_str }}</td>
                                <td>{{ item.budgeted_man_hours|round(2) }}</td>
                                <td>{{ item.earned_man_hours|round(2) }}</td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: {{ item.percent_complete_hours|round|int }}%" 
                                             aria-valuenow="{{ item.percent_complete_hours|round|int }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100"></div>
                                    </div>
                                    <div class="progress-value">{{ item.percent_complete_hours|round|int }}%</div>
                                </td>
                                <td>
                                    {% if item.status == 'completed' or item.percent_complete_hours >= 100 %}
                                        <span class="badge badge-status badge-completed">Completed</span>
                                    {% elif item.status == 'in_progress' or item.percent_complete_hours > 0 %}
                                        <span class="badge badge-status badge-in-progress">In Progress</span>
                                    {% elif item.status == 'on_hold' %}
                                        <span class="badge badge-status badge-on-hold">On Hold</span>
                                    {% else %}
                                        <span class="badge badge-status badge-not-started">Not Started</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('main.update_work_item_progress', work_item_id=item.id) }}" class="btn btn-sm btn-outline-light me-1" title="Update Progress">
                                        <i class="fas fa-chart-line"></i>
                                    </a>
                                    <a href="{{ url_for('main.edit_work_item', work_item_id=item.id) }}" class="btn btn-sm btn-outline-light me-1" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{{ url_for('main.view_work_item', work_item_id=item.id) }}" class="btn btn-sm btn-outline-light" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="empty-state">
                                    <i class="fas fa-tasks fa-4x mb-3"></i>
                                    <h4>No work items found</h4>
                                    <p>Get started by adding your first work item.</p>
                                    <a href="{{ url_for('main.add_work_item') }}" class="btn btn-primary mt-3">
                                        <i class="fas fa-plus"></i> Add Work Item
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Batch Actions -->
    <div class="filter-container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h4 class="mb-3">Batch Actions</h4>
                <div class="d-flex">
                    <a href="{{ url_for('main.batch_update_work_items') }}" class="btn btn-outline-light me-2">
                        <i class="fas fa-edit"></i> Batch Update Progress
                    </a>
                    <button class="btn btn-outline-light me-2" id="exportExcelBtn">
                        <i class="fas fa-file-excel"></i> Export to Excel
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex justify-content-end">
                    <div class="me-3">
                        <div class="d-flex align-items-center">
                            <span class="badge badge-status badge-completed me-2"></span>
                            <span>Completed: {{ status_counts.completed|default(0) }}</span>
                        </div>
                    </div>
                    <div class="me-3">
                        <div class="d-flex align-items-center">
                            <span class="badge badge-status badge-in-progress me-2"></span>
                            <span>In Progress: {{ status_counts.in_progress|default(0) }}</span>
                        </div>
                    </div>
                    <div class="me-3">
                        <div class="d-flex align-items-center">
                            <span class="badge badge-status badge-not-started me-2"></span>
                            <span>Not Started: {{ status_counts.not_started|default(0) }}</span>
                        </div>
                    </div>
                    <div>
                        <div class="d-flex align-items-center">
                            <span class="badge badge-status badge-on-hold me-2"></span>
                            <span>On Hold: {{ status_counts.on_hold|default(0) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Project and Sub Job selection
    document.getElementById('projectSelect').addEventListener('change', function() {
        const projectId = this.value;
        const subJobSelect = document.getElementById('subJobSelect');
        
        // Clear current options
        while (subJobSelect.options.length > 1) {
            subJobSelect.remove(1);
        }
        
        if (projectId === 'all') {
            subJobSelect.disabled = true;
            return;
        }
        
        // Fetch sub jobs for selected project
        fetch(`/api/project/${projectId}/sub_jobs`)
            .then(response => response.json())
            .then(data => {
                subJobSelect.disabled = false;
                
                data.forEach(subJob => {
                    const option = document.createElement('option');
                    option.value = subJob.id;
                    option.textContent = `${subJob.sub_job_id_str}: ${subJob.name}`;
                    subJobSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching sub jobs:', error));
    });
    
    // Apply selection button
    document.getElementById('applySelection').addEventListener('click', function() {
        const projectId = document.getElementById('projectSelect').value;
        const subJobId = document.getElementById('subJobSelect').value;
        
        // Redirect to filtered view
        window.location.href = `/work_items?project=${projectId}&sub_job=${subJobId}`;
    });
    
    // Search functionality
    document.getElementById('searchInput').addEventListener('input', function() {
        filterWorkItems();
    });
    
    // Filter dropdowns
    document.getElementById('costCodeFilter').addEventListener('change', function() {
        filterWorkItems();
    });
    
    document.getElementById('statusFilter').addEventListener('change', function() {
        filterWorkItems();
    });
    
    // Sort dropdown
    document.getElementById('sortBy').addEventListener('change', function() {
        sortWorkItems(this.value);
    });
    
    // Apply filters button
    document.getElementById('applyFilters').addEventListener('click', function() {
        filterWorkItems();
    });
    
    // Export to Excel button
    document.getElementById('exportExcelBtn').addEventListener('click', function() {
        const projectId = document.getElementById('projectSelect').value;
        const subJobId = document.getElementById('subJobSelect').value;
        const searchTerm = document.getElementById('searchInput').value;
        const costCodeId = document.getElementById('costCodeFilter').value;
        const status = document.getElementById('statusFilter').value;
        
        // Build export URL with current filters
        let exportUrl = `/export/work_items?format=excel`;
        if (projectId !== 'all') exportUrl += `&project=${projectId}`;
        if (subJobId !== 'all') exportUrl += `&sub_job=${subJobId}`;
        if (searchTerm) exportUrl += `&search=${encodeURIComponent(searchTerm)}`;
        if (costCodeId !== 'all') exportUrl += `&cost_code=${costCodeId}`;
        if (status !== 'all') exportUrl += `&status=${status}`;
        
        window.location.href = exportUrl;
    });
    
    // Filter work items function
    function filterWorkItems() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const costCodeFilter = document.getElementById('costCodeFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        
        const rows = document.querySelectorAll('.work-item-row');
        
        rows.forEach(row => {
            const id = row.cells[0].textContent.toLowerCase();
            const description = row.cells[1].textContent.toLowerCase();
            const costCodeId = row.getAttribute('data-costcode');
            const status = row.getAttribute('data-status');
            
            const matchesSearch = id.includes(searchTerm) || description.includes(searchTerm);
            const matchesCostCode = costCodeFilter === 'all' || costCodeId === costCodeFilter;
            const matchesStatus = statusFilter === 'all' || status === statusFilter;
            
            if (matchesSearch && matchesCostCode && matchesStatus) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    // Sort work items function
    function sortWorkItems(sortBy) {
        const tbody = document.getElementById('workItemsTableBody');
        const rows = Array.from(tbody.querySelectorAll('.work-item-row'));
        
        rows.sort((a, b) => {
            let valueA, valueB;
            
            if (sortBy === 'id') {
                valueA = a.cells[0].textContent;
                valueB = b.cells[0].textContent;
                return valueA.localeCompare(valueB);
            } else if (sortBy === 'description') {
                valueA = a.cells[1].textContent;
                valueB = b.cells[1].textContent;
                return valueA.localeCompare(valueB);
            } else if (sortBy === 'progress') {
                valueA = parseInt(a.getAttribute('data-progress')) || 0;
                valueB = parseInt(b.getAttribute('data-progress')) || 0;
                return valueB - valueA; // Descending order
            } else if (sortBy === 'cost_code') {
                valueA = a.cells[2].textContent;
                valueB = b.cells[2].textContent;
                return valueA.localeCompare(valueB);
            }
            
            return 0;
        });
        
        // Re-append sorted rows
        rows.forEach(row => tbody.appendChild(row));
    }
</script>
{% endblock %}

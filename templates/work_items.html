{% extends 'base.html' %}

{% block title %}Work Items - Magellan EV Tracker{% endblock %}

{% block page_title %}Work Items{% endblock %}

{% block header_actions %}
<a href="{{ url_for('main.add_work_item') }}" class="btn-primary">
    <i class="fas fa-plus"></i> Add Work Item
</a>
<a href="{{ url_for('main.batch_update_work_items') }}" class="btn-outline-light ms-2">
    <i class="fas fa-edit"></i> Batch Update
</a>
{% endblock %}

{% block content %}
<!-- Filters -->
<div class="filter-container">
    <div class="row g-3">
        <div class="col-md-3">
            <label for="project-filter" class="form-label">Project</label>
            <select id="project-filter" class="form-select">
                <option value="">All Projects</option>
                {% for project in projects %}
                <option value="{{ project.id }}">{{ project.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="sub-job-filter" class="form-label">Sub Job</label>
            <select id="sub-job-filter" class="form-select">
                <option value="">All Sub Jobs</option>
                <!-- Sub jobs will be populated via JavaScript -->
            </select>
        </div>
        <div class="col-md-3">
            <label for="discipline-filter" class="form-label">Discipline</label>
            <select id="discipline-filter" class="form-select">
                <option value="">All Disciplines</option>
                {% for discipline_value, discipline_name in disciplines %}
                <option value="{{ discipline_value }}">{{ discipline_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="area-filter" class="form-label">Area</label>
            <select id="area-filter" class="form-select">
                <option value="">All Areas</option>
                <!-- Areas will be populated via JavaScript -->
            </select>
        </div>
    </div>
</div>

<!-- Work Items Table -->
<div class="data-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="title">Work Items</h2>
        <div>
            <span id="item-count" class="badge bg-info">{{ work_items|length }} items</span>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Description</th>
                    <th>Cost Code</th>
                    <th>Discipline</th>
                    <th>Area</th>
                    <th>Progress</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="work-items-table-body">
                {% for item in work_items %}
                <tr data-project="{{ item.sub_job.project_id }}" data-subjob="{{ item.sub_job_id }}" data-discipline="{{ item.cost_code.discipline }}" data-area="{{ item.sub_job.area }}">
                    <td>{{ item.work_item_id_str }}</td>
                    <td>{{ item.description }}</td>
                    <td>{{ item.cost_code.cost_code_id_str }}</td>
                    <td>{{ item.cost_code.get_discipline_display() }}</td>
                    <td>{{ item.sub_job.area }}</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: {{ item.percent_complete }}%;" aria-valuenow="{{ item.percent_complete }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="progress-value">{{ item.percent_complete }}%</div>
                    </td>
                    <td>
                        <a href="{{ url_for('main.view_work_item', work_item_id=item.id) }}" class="btn-outline-light btn-sm me-1">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="{{ url_for('main.edit_work_item', work_item_id=item.id) }}" class="btn-outline-light btn-sm me-1">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="{{ url_for('main.update_work_item_progress', work_item_id=item.id) }}" class="btn-outline-light btn-sm">
                            <i class="fas fa-chart-line"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Empty State -->
    {% if not work_items %}
    <div class="empty-state">
        <i class="fas fa-clipboard-list fa-4x mb-3"></i>
        <h3>No Work Items Found</h3>
        <p>Get started by adding your first work item.</p>
        <a href="{{ url_for('main.add_work_item') }}" class="btn-primary mt-3">
            <i class="fas fa-plus"></i> Add Work Item
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get filter elements
        const projectFilter = document.getElementById('project-filter');
        const subJobFilter = document.getElementById('sub-job-filter');
        const disciplineFilter = document.getElementById('discipline-filter');
        const areaFilter = document.getElementById('area-filter');
        const tableBody = document.getElementById('work-items-table-body');
        const itemCount = document.getElementById('item-count');
        
        // Store all rows for filtering
        const allRows = Array.from(tableBody.querySelectorAll('tr'));
        
        // Populate sub job filter based on selected project
        projectFilter.addEventListener('change', function() {
            const projectId = this.value;
            
            // Clear current options
            subJobFilter.innerHTML = '<option value="">All Sub Jobs</option>';
            
            // If a project is selected, fetch its sub jobs
            if (projectId) {
                fetch(`/api/project/${projectId}/sub_jobs`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(subJob => {
                            const option = document.createElement('option');
                            option.value = subJob.id;
                            option.textContent = subJob.name;
                            subJobFilter.appendChild(option);
                        });
                    });
            }
            
            // Apply filters
            applyFilters();
        });
        
        // Populate unique areas
        function populateAreas() {
            const areas = new Set();
            
            allRows.forEach(row => {
                const area = row.getAttribute('data-area');
                if (area) areas.add(area);
            });
            
            // Clear current options
            areaFilter.innerHTML = '<option value="">All Areas</option>';
            
            // Add area options
            Array.from(areas).sort().forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                areaFilter.appendChild(option);
            });
        }
        
        // Initial population of areas
        populateAreas();
        
        // Apply filters when any filter changes
        subJobFilter.addEventListener('change', applyFilters);
        disciplineFilter.addEventListener('change', applyFilters);
        areaFilter.addEventListener('change', applyFilters);
        
        // Filter function
        function applyFilters() {
            const projectId = projectFilter.value;
            const subJobId = subJobFilter.value;
            const discipline = disciplineFilter.value;
            const area = areaFilter.value;
            
            let visibleCount = 0;
            
            allRows.forEach(row => {
                const rowProjectId = row.getAttribute('data-project');
                const rowSubJobId = row.getAttribute('data-subjob');
                const rowDiscipline = row.getAttribute('data-discipline');
                const rowArea = row.getAttribute('data-area');
                
                // Check if row matches all selected filters
                const projectMatch = !projectId || rowProjectId === projectId;
                const subJobMatch = !subJobId || rowSubJobId === subJobId;
                const disciplineMatch = !discipline || rowDiscipline === discipline;
                const areaMatch = !area || rowArea === area;
                
                // Show/hide row based on filter match
                if (projectMatch && subJobMatch && disciplineMatch && areaMatch) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update item count
            itemCount.textContent = `${visibleCount} items`;
        }
    });
</script>
{% endblock %}

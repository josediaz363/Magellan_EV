{% extends 'base.html' %}

{% block title %}Magellan EV - View Work Item{% endblock %}

{% block page_title %}Work Item Details{% endblock %}

{% block header_actions %}
    <a href="{{ url_for('main.edit_work_item', work_item_id=work_item.id) }}" class="btn btn-primary">
        <i class="fas fa-edit"></i> Edit
    </a>
    <a href="{{ url_for('main.update_work_item_progress', work_item_id=work_item.id) }}" class="btn btn-secondary">
        <i class="fas fa-chart-line"></i> Update Progress
    </a>
    <button class="btn btn-danger" onclick="confirmDelete({{ work_item.id }})">
        <i class="fas fa-trash"></i> Delete
    </button>
{% endblock %}

{% block content %}
    <div class="detail-container">
        <div class="detail-section">
            <h3>Basic Information</h3>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Work Item ID</div>
                    <div class="detail-value">{{ work_item.work_item_id_str }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Description</div>
                    <div class="detail-value">{{ work_item.description }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Project</div>
                    <div class="detail-value">
                        <a href="{{ url_for('main.view_project', project_id=work_item.project_id) }}">
                            {{ work_item.project.name if work_item.project else 'N/A' }}
                        </a>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Sub Job</div>
                    <div class="detail-value">
                        <a href="{{ url_for('main.view_sub_job', sub_job_id=work_item.sub_job_id) }}">
                            {{ work_item.sub_job.name if work_item.sub_job else 'N/A' }}
                        </a>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Cost Code</div>
                    <div class="detail-value">{{ work_item.cost_code.cost_code_id_str if work_item.cost_code else 'N/A' }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Rule of Credit</div>
                    <div class="detail-value">{{ work_item.cost_code.rule_of_credit.name if work_item.cost_code and work_item.cost_code.rule_of_credit else 'N/A' }}</div>
                </div>
            </div>
        </div>

        <div class="detail-section">
            <h3>Quantities and Hours</h3>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Budgeted Quantity</div>
                    <div class="detail-value">{{ work_item.budgeted_quantity }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Unit of Measure</div>
                    <div class="detail-value">{{ work_item.unit_of_measure }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Earned Quantity</div>
                    <div class="detail-value">{{ work_item.earned_quantity|round(1) }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Quantity % Complete</div>
                    <div class="detail-value">{{ work_item.percent_complete_quantity|round(1) }}%</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Budgeted Man Hours</div>
                    <div class="detail-value">{{ work_item.budgeted_man_hours }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Earned Man Hours</div>
                    <div class="detail-value">{{ work_item.earned_man_hours|round(1) }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Hours % Complete</div>
                    <div class="detail-value">{{ work_item.percent_complete_hours|round(1) }}%</div>
                </div>
            </div>
        </div>

        <div class="detail-section">
            <h3>Progress by Step</h3>
            <div class="progress-table">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Step</th>
                            <th>Weight</th>
                            <th>Completion</th>
                            <th>Progress</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if work_item.cost_code and work_item.cost_code.rule_of_credit %}
                            {% set steps = work_item.cost_code.rule_of_credit.get_steps() %}
                            {% set progress = work_item.get_steps_progress() %}
                            {% for step in steps %}
                                <tr>
                                    <td>{{ step.name }}</td>
                                    <td>{{ step.weight }}%</td>
                                    <td>{{ progress.get(step.name, 0)|round(1) }}%</td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" style="width: {{ progress.get(step.name, 0) }}%;" aria-valuenow="{{ progress.get(step.name, 0) }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="4" class="text-center">No rule of credit assigned</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>Confirm Delete</h3>
            <p>Are you sure you want to delete this work item? This action cannot be undone.</p>
            <div class="modal-actions">
                <button id="cancelDelete" class="btn btn-secondary">Cancel</button>
                <form id="deleteForm" method="POST" action="{{ url_for('main.delete_work_item', work_item_id=work_item.id) }}">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    function confirmDelete(workItemId) {
        const modal = document.getElementById('deleteModal');
        const cancelBtn = document.getElementById('cancelDelete');
        
        // Show the modal
        modal.style.display = 'flex';
        
        // Close modal when cancel is clicked
        cancelBtn.onclick = function() {
            modal.style.display = 'none';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    }
</script>
{% endblock %}

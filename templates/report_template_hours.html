{% extends "base.html" %}

{% block title %}Hours Report{% endblock %}

{% block content %}
<div class="header">
    <div>
        <img src="/home/ubuntu/upload/Fortis.png" alt="Fortis Construction Inc." class="logo">
    </div>
    <div class="project-info">
        <h1>PROGRESS DETAIL</h1>
        {% if sub_job %}
            <h2>Sub Job by Hours</h2>
            <p>{{ sub_job.sub_job_id_str }} - {{ sub_job.name }}</p>
        {% else %}
            <h2>Total Project by Hours</h2>
        {% endif %}
        <p>Project: {{ project.project_id_str }} - {{ project.name }}</p>
        <p>Progress Thru: {{ report_date }}</p>
        <p>Page 1 of 1</p>
    </div>
</div>

{% if grouped_work_items %}
    {% for discipline_name, discipline_data in grouped_work_items.items() %}
        <h3>DISCIPLINE: {{ discipline_name }}</h3>
        
        {% for cost_code_name, cost_code_data in discipline_data.cost_codes.items() %}
            <h4>{{ cost_code_name }}</h4>
            
            <table>
                <thead>
                    <tr>
                        <th>Work Item ID</th>
                        <th>Description</th>
                        <th>BUDGETED HOURS</th>
                        <th>EARNED HOURS</th>
                        <th>PCT COMP</th>
                        {% for step_name in all_roc_step_names %}
                            <th>{{ step_name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for work_item in cost_code_data.work_items %}
                        <tr>
                            <td>{{ work_item.work_item_id_str }}</td>
                            <td>{{ work_item.description }}</td>
                            <td class="numeric">{{ "%.2f"|format(work_item.budgeted_man_hours) if work_item.budgeted_man_hours is not none else "0.00" }}</td>
                            <td class="numeric">{{ "%.2f"|format(work_item.earned_man_hours) if work_item.earned_man_hours is not none else "0.00" }}</td>
                            <td class="numeric">{{ "%.1f"|format(work_item.percent_complete_hours) if work_item.percent_complete_hours is not none else "0.0" }}%</td>
                            
                            {% for step_name in all_roc_step_names %}
                                <td class="numeric">
                                    {% if work_item.rule_of_credit and work_item.progress_json %}
                                        {% set progress_data = work_item.progress_json|tojson|fromjson %}
                                        {% if step_name in progress_data %}
                                            {{ "%.1f"|format(progress_data[step_name]) }}%
                                        {% else %}
                                            0.0%
                                        {% endif %}
                                    {% else %}
                                        0.0%
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                    
                    <!-- Cost Code Subtotal -->
                    <tr class="subtotal-row">
                        <td colspan="2" style="text-align: right;">{{ cost_code_name }} Subtotal:</td>
                        <td class="numeric">{{ "%.2f"|format(cost_code_data.subtotals.budgeted_hours) }}</td>
                        <td class="numeric">{{ "%.2f"|format(cost_code_data.subtotals.earned_hours) }}</td>
                        <td class="numeric">{{ "%.1f"|format(cost_code_data.subtotals.percent_complete_hours) }}%</td>
                        <td colspan="{{ all_roc_step_names|length }}"></td>
                    </tr>
                </tbody>
            </table>
        {% endfor %}
        
        <!-- Discipline Subtotal -->
        <table>
            <tr class="total-row">
                <td colspan="2" style="text-align: right;">{{ discipline_name }} Discipline Total:</td>
                <td class="numeric">{{ "%.2f"|format(discipline_data.subtotals.budgeted_hours) }}</td>
                <td class="numeric">{{ "%.2f"|format(discipline_data.subtotals.earned_hours) }}</td>
                <td class="numeric">{{ "%.1f"|format(discipline_data.subtotals.percent_complete_hours) }}%</td>
                <td colspan="{{ all_roc_step_names|length }}"></td>
            </tr>
        </table>
    {% endfor %}
    
    <!-- Project Grand Total -->
    <table>
        <tr class="total-row">
            <td colspan="2" style="text-align: right; font-weight: bold;">PROJECT GRAND TOTAL:</td>
            <td class="numeric" style="font-weight: bold;">{{ "%.2f"|format(project_totals.budgeted_hours) }}</td>
            <td class="numeric" style="font-weight: bold;">{{ "%.2f"|format(project_totals.earned_hours) }}</td>
            <td class="numeric" style="font-weight: bold;">{{ "%.1f"|format(project_totals.percent_complete_hours) }}%</td>
            <td colspan="{{ all_roc_step_names|length }}"></td>
        </tr>
    </table>
{% else %}
    <p>No work items found for this project.</p>
{% endif %}

{% endblock %}

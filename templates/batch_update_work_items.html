{% extends 'base.html' %}

{% block title %}Batch Update Work Items - Magellan EV Tracker{% endblock %}

{% block page_title %}Batch Update Work Items{% endblock %}

{% block content %}
<div class="data-container">
    <div class="mb-4">
        <p>Use this form to update progress for multiple work items at once.</p>
    </div>
    
    <!-- Filters -->
    <div class="filter-container mb-4">
        <div class="row g-3">
            <div class="col-md-3">
                <label for="project-filter" class="form-label">Project</label>
                <select id="project-filter" class="form-select">
                    <option value="">All Projects</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="sub-job-filter" class="form-label">Sub Job</label>
                <select id="sub-job-filter" class="form-select">
                    <option value="">All Sub Jobs</option>
                    <!-- Sub jobs will be populated via JavaScript -->
                </select>
            </div>
            <div class="col-md-3">
                <label for="discipline-filter" class="form-label">Discipline</label>
                <select id="discipline-filter" class="form-select">
                    <option value="">All Disciplines</option>
                    {% for discipline_value, discipline_name in disciplines %}
                    <option value="{{ discipline_value }}">{{ discipline_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="area-filter" class="form-label">Area</label>
                <select id="area-filter" class="form-select">
                    <option value="">All Areas</option>
                    <!-- Areas will be populated via JavaScript -->
                </select>
            </div>
        </div>
    </div>
    
    <form method="POST">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="select-all" class="form-check-input">
                        </th>
                        <th>ID</th>
                        <th>Description</th>
                        <th>Cost Code</th>
                        <th>Area</th>
                        <th>Current Progress</th>
                        <th>New Progress</th>
                    </tr>
                </thead>
                <tbody id="work-items-table-body">
                    {% for item in work_items %}
                    <tr data-project="{{ item.sub_job.project_id }}" data-subjob="{{ item.sub_job_id }}" data-discipline="{{ item.cost_code.discipline }}" data-area="{{ item.sub_job.area }}">
                        <td>
                            <input type="checkbox" name="selected_items[]" value="{{ item.id }}" class="form-check-input item-checkbox">
                        </td>
                        <td>{{ item.work_item_id_str }}</td>
                        <td>{{ item.description }}</td>
                        <td>{{ item.cost_code.cost_code_id_str }}</td>
                        <td>{{ item.sub_job.area }}</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: {{ item.percent_complete }}%;" aria-valuenow="{{ item.percent_complete }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="progress-value">{{ item.percent_complete }}%</div>
                        </td>
                        <td>
                            <input type="range" class="form-range" min="0" max="100" step="1" name="progress_{{ item.id }}" value="{{ item.percent_complete }}">
                            <div class="d-flex justify-content-between">
                                <span class="small">0%</span>
                                <span class="small progress-display">{{ item.percent_complete }}%</span>
                                <span class="small">100%</span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="mt-4">
            <button type="submit" class="btn-primary" id="update-button" disabled>Update Selected Items</button>
            <a href="{{ url_for('main.work_items') }}" class="btn-outline-light ms-2">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get filter elements
        const projectFilter = document.getElementById('project-filter');
        const subJobFilter = document.getElementById('sub-job-filter');
        const disciplineFilter = document.getElementById('discipline-filter');
        const areaFilter = document.getElementById('area-filter');
        const tableBody = document.getElementById('work-items-table-body');
        const selectAll = document.getElementById('select-all');
        const itemCheckboxes = document.querySelectorAll('.item-checkbox');
        const updateButton = document.getElementById('update-button');
        const progressRanges = document.querySelectorAll('.form-range');
        const progressDisplays = document.querySelectorAll('.progress-display');
        
        // Store all rows for filtering
        const allRows = Array.from(tableBody.querySelectorAll('tr'));
        
        // Populate sub job filter based on selected project
        projectFilter.addEventListener('change', function() {
            const projectId = this.value;
            
            // Clear current options
            subJobFilter.innerHTML = '<option value="">All Sub Jobs</option>';
            
            // If a project is selected, fetch its sub jobs
            if (projectId) {
                fetch(`/api/project/${projectId}/sub_jobs`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(subJob => {
                            const option = document.createElement('option');
                            option.value = subJob.id;
                            option.textContent = subJob.name;
                            subJobFilter.appendChild(option);
                        });
                    });
            }
            
            // Apply filters
            applyFilters();
        });
        
        // Populate unique areas
        function populateAreas() {
            const areas = new Set();
            
            allRows.forEach(row => {
                const area = row.getAttribute('data-area');
                if (area) areas.add(area);
            });
            
            // Clear current options
            areaFilter.innerHTML = '<option value="">All Areas</option>';
            
            // Add area options
            Array.from(areas).sort().forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                areaFilter.appendChild(option);
            });
        }
        
        // Initial population of areas
        populateAreas();
        
        // Apply filters when any filter changes
        subJobFilter.addEventListener('change', applyFilters);
        disciplineFilter.addEventListener('change', applyFilters);
        areaFilter.addEventListener('change', applyFilters);
        
        // Filter function
        function applyFilters() {
            const projectId = projectFilter.value;
            const subJobId = subJobFilter.value;
            const discipline = disciplineFilter.value;
            const area = areaFilter.value;
            
            allRows.forEach(row => {
                const rowProjectId = row.getAttribute('data-project');
                const rowSubJobId = row.getAttribute('data-subjob');
                const rowDiscipline = row.getAttribute('data-discipline');
                const rowArea = row.getAttribute('data-area');
                
                // Check if row matches all selected filters
                const projectMatch = !projectId || rowProjectId === projectId;
                const subJobMatch = !subJobId || rowSubJobId === subJobId;
                const disciplineMatch = !discipline || rowDiscipline === discipline;
                const areaMatch = !area || rowArea === area;
                
                // Show/hide row based on filter match
                if (projectMatch && subJobMatch && disciplineMatch && areaMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                    // Uncheck hidden rows
                    const checkbox = row.querySelector('.item-checkbox');
                    if (checkbox) checkbox.checked = false;
                }
            });
            
            // Update select all checkbox state
            updateSelectAllState();
            // Update update button state
            updateButtonState();
        }
        
        // Select all checkbox functionality
        selectAll.addEventListener('change', function() {
            const visibleCheckboxes = Array.from(itemCheckboxes).filter(checkbox => 
                checkbox.closest('tr').style.display !== 'none'
            );
            
            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            
            // Update update button state
            updateButtonState();
        });
        
        // Individual checkbox change
        itemCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectAllState();
                updateButtonState();
            });
        });
        
        // Update select all checkbox state
        function updateSelectAllState() {
            const visibleCheckboxes = Array.from(itemCheckboxes).filter(checkbox => 
                checkbox.closest('tr').style.display !== 'none'
            );
            
            const allChecked = visibleCheckboxes.every(checkbox => checkbox.checked);
            const someChecked = visibleCheckboxes.some(checkbox => checkbox.checked);
            
            selectAll.checked = allChecked;
            selectAll.indeterminate = someChecked && !allChecked;
        }
        
        // Update button state
        function updateButtonState() {
            const anyChecked = Array.from(itemCheckboxes).some(checkbox => checkbox.checked);
            updateButton.disabled = !anyChecked;
        }
        
        // Progress range input
        progressRanges.forEach((range, index) => {
            range.addEventListener('input', function() {
                progressDisplays[index].textContent = this.value + '%';
            });
        });
    });
</script>
{% endblock %}

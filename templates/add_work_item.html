{% extends "base.html" %}

{% block title %}Magellan EV - Add Work Item{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="page-title">Add Work Item</h1>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <form method="POST" action="{{ url_for('main.add_work_item') }}">
                {{ form.hidden_tag() }}
                <div class="form-group">
                    <label for="work_item_id">Work Item ID</label>
                    {{ form.work_item_id(class="form-control", placeholder="Auto-generated if left blank") }}
                </div>
                <div class="form-group">
                    <label for="description">Description *</label>
                    {{ form.description(class="form-control", required=true) }}
                </div>
                <div class="form-group">
                    <label for="project_id">Project *</label>
                    {{ form.project_id(class="form-control", required=true) }}
                </div>
                <div class="form-group">
                    <label for="sub_job_id">Sub Job *</label>
                    {{ form.sub_job_id(class="form-control", required=true) }}
                </div>
                <div class="form-group">
                    <label for="cost_code_id">Cost Code *</label>
                    {{ form.cost_code_id(class="form-control", required=true) }}
                </div>
                <div class="form-group">
                    <label for="budgeted_quantity">Budgeted Quantity</label>
                    {{ form.budgeted_quantity(class="form-control", value=0) }}
                </div>
                <div class="form-group">
                    <label for="unit_of_measure">Unit of Measure</label>
                    {{ form.unit_of_measure(class="form-control") }}
                </div>
                <div class="form-group">
                    <label for="budgeted_man_hours">Budgeted Man Hours</label>
                    {{ form.budgeted_man_hours(class="form-control", value=0) }}
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Create Work Item</button>
                    <a href="{{ url_for('main.list_work_items') }}" class="btn btn-link">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function updateSubJobs() {
        // Get the select element first
        const projectSelect = document.getElementById('project_id');
        // Get the selected option value
        const projectId = projectSelect.options[projectSelect.selectedIndex].value;
        const subJobSelect = document.getElementById('sub_job_id');
        const costCodeSelect = document.getElementById('cost_code_id');
        
        console.log("Selected project ID:", projectId);
        
        if (projectId && projectId !== '') {
            console.log("Fetching sub jobs for project ID:", projectId);
            // Fetch sub jobs for the selected project via AJAX
            fetch(`/api/get_sub_jobs/${projectId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Received sub jobs:", data);
                    // Clear existing options except the placeholder
                    while (subJobSelect.options.length > 1) {
                        subJobSelect.remove(1);
                    }
                    
                    // Add new options
                    data.forEach(subJob => {
                        const option = document.createElement('option');
                        option.value = subJob.id;
                        option.textContent = subJob.name;
                        option.setAttribute('data-project', projectId);
                        subJobSelect.appendChild(option);
                    });
                    
                    // Enable the select
                    subJobSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Error fetching sub jobs:', error);
                    alert('Error loading sub jobs. Please try again or contact support.');
                });
        } else {
            console.log("No project selected, clearing sub job dropdown");
            // Clear and disable sub job select if no project selected
            while (subJobSelect.options.length > 1) {
                subJobSelect.remove(1);
            }
            subJobSelect.disabled = true;
        }
        
        // Hide all cost codes
        for (let i = 0; i < costCodeSelect.options.length; i++) {
            const option = costCodeSelect.options[i];
            if (option.value === '') {
                option.style.display = 'block'; // Always show the placeholder
            } else {
                const optionProjectId = option.getAttribute('data-project');
                option.style.display = (optionProjectId === projectId) ? 'block' : 'none';
            }
        }
        
        // Reset selection if current selection is now hidden
        if (costCodeSelect.selectedIndex > 0) {
            const selectedOption = costCodeSelect.options[costCodeSelect.selectedIndex];
            if (selectedOption.style.display === 'none') {
                costCodeSelect.value = '';
            }
        }
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateSubJobs();
        
        // Add event listener for project selection change
        document.getElementById('project_id').addEventListener('change', updateSubJobs);
    });
</script>
{% endblock %}

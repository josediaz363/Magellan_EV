{% extends 'base.html' %}

{% block title %}Cost Codes - Magellan EV Tracker{% endblock %}

{% block page_title %}Cost Codes{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Cost Codes</h2>
    <div>
        <a href="{{ url_for('main.add_cost_code') }}" class="btn-primary">
            <i class="fas fa-plus"></i> Add Cost Code
        </a>
    </div>
</div>

<!-- Filters -->
<div class="filter-container mb-4">
    <div class="row g-3">
        <div class="col-md-4">
            <input type="text" id="search-input" class="form-control" placeholder="Search cost codes...">
        </div>
        <div class="col-md-3">
            <select id="discipline-filter" class="form-select">
                <option value="">All Disciplines</option>
                {% for discipline_value, discipline_name in disciplines %}
                <option value="{{ discipline_value }}">{{ discipline_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <select id="sort-by" class="form-select">
                <option value="code">Sort By Code ID</option>
                <option value="description">Sort By Description</option>
                <option value="discipline">Sort By Discipline</option>
            </select>
        </div>
        <div class="col-md-2">
            <button id="filter-button" class="btn-outline-light w-100">Filter</button>
        </div>
    </div>
</div>

<!-- Cost Codes Table -->
<div class="data-container">
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Code ID</th>
                    <th>Description</th>
                    <th>Discipline</th>
                    <th>Unit of Measure</th>
                    <th>Rule of Credit</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="cost-codes-table-body">
                {% for cost_code in cost_codes %}
                <tr data-discipline="{{ cost_code.discipline }}">
                    <td>{{ cost_code.cost_code_id_str }}</td>
                    <td>{{ cost_code.description }}</td>
                    <td>
                        <span class="badge badge-discipline badge-{{ cost_code.get_discipline_display().lower() }}">
                            {{ cost_code.get_discipline_display() }}
                        </span>
                    </td>
                    <td>{{ cost_code.uom or 'N/A' }}</td>
                    <td>{{ cost_code.rule_of_credit.name if cost_code.rule_of_credit else 'None' }}</td>
                    <td>
                        <a href="{{ url_for('main.edit_cost_code', cost_code_id=cost_code.id) }}" class="btn-sm btn-outline-light me-1">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button class="btn-sm btn-outline-light delete-btn" data-id="{{ cost_code.id }}" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center">No cost codes found. <a href="{{ url_for('main.add_cost_code') }}">Add one now</a>.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this cost code? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                <form id="delete-form" method="POST" action="">
                    <button type="submit" class="btn-primary">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Delete confirmation
        const deleteButtons = document.querySelectorAll('.delete-btn');
        const deleteForm = document.getElementById('delete-form');
        
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const costCodeId = this.getAttribute('data-id');
                deleteForm.action = `/delete_cost_code/${costCodeId}`;
            });
        });
        
        // Filtering and searching
        const searchInput = document.getElementById('search-input');
        const disciplineFilter = document.getElementById('discipline-filter');
        const sortBy = document.getElementById('sort-by');
        const filterButton = document.getElementById('filter-button');
        const tableBody = document.getElementById('cost-codes-table-body');
        const allRows = Array.from(tableBody.querySelectorAll('tr'));
        
        filterButton.addEventListener('click', applyFilters);
        
        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const discipline = disciplineFilter.value;
            
            allRows.forEach(row => {
                const rowDiscipline = row.getAttribute('data-discipline');
                const rowText = row.textContent.toLowerCase();
                
                const disciplineMatch = !discipline || rowDiscipline === discipline;
                const searchMatch = !searchTerm || rowText.includes(searchTerm);
                
                if (disciplineMatch && searchMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Apply sorting
            sortRows();
        }
        
        function sortRows() {
            const sortOption = sortBy.value;
            const rows = Array.from(tableBody.querySelectorAll('tr:not([style*="display: none"])'));
            
            rows.sort((a, b) => {
                let aValue, bValue;
                
                if (sortOption === 'code') {
                    aValue = a.cells[0].textContent;
                    bValue = b.cells[0].textContent;
                } else if (sortOption === 'description') {
                    aValue = a.cells[1].textContent;
                    bValue = b.cells[1].textContent;
                } else if (sortOption === 'discipline') {
                    aValue = a.cells[2].textContent;
                    bValue = b.cells[2].textContent;
                }
                
                return aValue.localeCompare(bValue);
            });
            
            // Reorder rows
            rows.forEach(row => {
                tableBody.appendChild(row);
            });
        }
    });
</script>
{% endblock %}

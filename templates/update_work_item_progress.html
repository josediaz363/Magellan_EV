{% extends "base.html" %}

{% block title %}Update Work Item Progress - Magellan EV Tracker{% endblock %}

{% block content %}
    <div class="navbar">
        <div class="d-flex justify-content-between align-items-center w-100">
            <h2>Update Work Item Progress</h2>
            <div>
                <a href="{{ url_for('main.work_items') }}" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left"></i> Back to Work Items
                </a>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="data-container">
                <h4 class="mb-3">Work Item Details</h4>
                <table class="table">
                    <tr>
                        <th>Work Item ID:</th>
                        <td>{{ work_item.work_item_id_str }}</td>
                    </tr>
                    <tr>
                        <th>Description:</th>
                        <td>{{ work_item.description }}</td>
                    </tr>
                    <tr>
                        <th>Cost Code:</th>
                        <td>{{ cost_code.cost_code_id_str if cost_code else 'N/A' }}</td>
                    </tr>
                    <tr>
                        <th>Rule of Credit:</th>
                        <td>{{ rule.name if rule else 'N/A' }}</td>
                    </tr>
                    <tr>
                        <th>Budgeted Hours:</th>
                        <td>{{ work_item.budgeted_man_hours|round(2) }}</td>
                    </tr>
                    <tr>
                        <th>Earned Hours:</th>
                        <td>{{ work_item.earned_man_hours|round(2) }}</td>
                    </tr>
                    <tr>
                        <th>Current Progress:</th>
                        <td>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ work_item.percent_complete_hours|round|int }}%" 
                                     aria-valuenow="{{ work_item.percent_complete_hours|round|int }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100"></div>
                            </div>
                            <div class="progress-value">{{ work_item.percent_complete_hours|round|int }}%</div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="data-container">
                <h4 class="mb-3">Planned vs. Actual Progress</h4>
                <form method="post" action="{{ url_for('main.update_planned_progress', work_item_id=work_item.id) }}" class="mb-4">
                    <div class="mb-3">
                        <label class="form-label">Planned % Complete</label>
                        <input type="number" class="form-control" name="planned_percent_complete" value="{{ work_item.planned_percent_complete|round|int }}" min="0" max="100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Interval Type</label>
                        <select class="form-select" name="interval_type">
                            <option value="days" {% if work_item.interval_type == 'days' %}selected{% endif %}>Days</option>
                            <option value="weeks" {% if work_item.interval_type == 'weeks' or not work_item.interval_type %}selected{% endif %}>Weeks</option>
                            <option value="months" {% if work_item.interval_type == 'months' %}selected{% endif %}>Months</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Planned Start Date</label>
                        <input type="date" class="form-control" name="planned_start_date" value="{{ work_item.planned_start_date.strftime('%Y-%m-%d') if work_item.planned_start_date else '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Planned End Date</label>
                        <input type="date" class="form-control" name="planned_end_date" value="{{ work_item.planned_end_date.strftime('%Y-%m-%d') if work_item.planned_end_date else '' }}">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Update Planned Progress
                    </button>
                </form>
                
                <div class="progress-comparison">
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Planned Progress:</span>
                            <span>{{ work_item.planned_percent_complete|round|int }}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-info" role="progressbar" 
                                 style="width: {{ work_item.planned_percent_complete|round|int }}%" 
                                 aria-valuenow="{{ work_item.planned_percent_complete|round|int }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Actual Progress:</span>
                            <span>{{ work_item.percent_complete_hours|round|int }}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar {% if work_item.is_behind_schedule %}bg-danger{% elif work_item.is_ahead_schedule %}bg-success{% else %}bg-warning{% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ work_item.percent_complete_hours|round|int }}%" 
                                 aria-valuenow="{{ work_item.percent_complete_hours|round|int }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between">
                            <span>Variance:</span>
                            <span class="{% if work_item.is_behind_schedule %}text-danger{% elif work_item.is_ahead_schedule %}text-success{% else %}text-warning{% endif %}">
                                {{ work_item.variance_percent|round(1) }}%
                                {% if work_item.is_behind_schedule %}
                                    (Behind Schedule)
                                {% elif work_item.is_ahead_schedule %}
                                    (Ahead of Schedule)
                                {% else %}
                                    (On Schedule)
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form method="post" action="{{ url_for('main.update_work_item_progress', work_item_id=work_item.id) }}">
        <div class="data-container">
            <h4 class="mb-3">Update Progress by Rules of Credit</h4>
            
            <div class="mb-3">
                <label class="form-label">Status</label>
                <select class="form-select" name="status">
                    <option value="not_started" {% if work_item.status == 'not_started' %}selected{% endif %}>Not Started</option>
                    <option value="in_progress" {% if work_item.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                    <option value="completed" {% if work_item.status == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="on_hold" {% if work_item.status == 'on_hold' %}selected{% endif %}>On Hold</option>
                </select>
            </div>
            
            {% if steps %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Step</th>
                                <th>Weight</th>
                                <th>Progress (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for step in steps %}
                                <tr>
                                    <td>{{ step.name }}</td>
                                    <td>{{ step.weight }}</td>
                                    <td>
                                        <input type="number" class="form-control" name="step_{{ step.name }}" 
                                               value="{{ progress_data.get(step.name, 0)|round|int }}" min="0" max="100">
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    No Rules of Credit steps found for this work item. Please assign a Rule of Credit to the Cost Code.
                </div>
            {% endif %}
            
            <div class="mt-4">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Update Progress
                </button>
                <a href="{{ url_for('main.work_items') }}" class="btn btn-outline-light ms-2">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </div>
    </form>
{% endblock %}

{% extends "base.html" %}

{% block title %}Update Work Item Progress - Magellan EV Tracker{% endblock %}

{% block page_title %}Update Work Item Progress{% endblock %}

{% block content %}
<div class="data-container">
    <div class="row">
        <div class="col-md-6">
            <h3>{{ work_item.work_item_id_str }}</h3>
            <p>{{ work_item.description }}</p>
            
            <div class="mt-4 mb-4">
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: {{ work_item.percent_complete_hours|round(0) }}%" 
                        aria-valuenow="{{ work_item.percent_complete_hours|round(0) }}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="progress-value">{{ work_item.percent_complete_hours|round(0) }}% Complete</div>
            </div>
            
            <table class="table">
                <tr>
                    <th>Project:</th>
                    <td>{{ project.project_id_str }}: {{ project.name }}</td>
                </tr>
                <tr>
                    <th>Sub Job:</th>
                    <td>{{ sub_job.sub_job_id_str }}: {{ sub_job.name }}</td>
                </tr>
                <tr>
                    <th>Cost Code:</th>
                    <td>{{ cost_code.cost_code_id_str }}: {{ cost_code.description }}</td>
                </tr>
                <tr>
                    <th>Budgeted Hours:</th>
                    <td>{{ work_item.budgeted_man_hours|round(2) }}</td>
                </tr>
                <tr>
                    <th>Earned Hours:</th>
                    <td>{{ work_item.earned_man_hours|round(2) }}</td>
                </tr>
            </table>
        </div>
        
        <div class="col-md-6">
            <form method="POST" action="{{ url_for('main.update_work_item_progress', work_item_id=work_item.id) }}">
                <h4>Update Progress by Rule of Credit Steps</h4>
                {% if rule_of_credit %}
                    {% for step in rule_steps %}
                    <div class="mb-3">
                        <label for="step_{{ loop.index }}" class="form-label">{{ step.name }} (Weight: {{ step.weight }}%)</label>
                        <div class="input-group">
                            <input type="range" class="form-range" id="step_range_{{ loop.index }}" 
                                   min="0" max="100" step="5" 
                                   value="{{ step_progress.get(step.name, 0)|round(0) }}"
                                   oninput="document.getElementById('step_{{ loop.index }}').value = this.value">
                            <input type="number" class="form-control" id="step_{{ loop.index }}" 
                                   name="step_{{ step.name }}" min="0" max="100" 
                                   value="{{ step_progress.get(step.name, 0)|round(0) }}"
                                   oninput="document.getElementById('step_range_{{ loop.index }}').value = this.value">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    {% endfor %}
                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary">Update Progress</button>
                        <a href="{{ url_for('main.view_work_item', work_item_id=work_item.id) }}" class="btn btn-outline-light ms-2">Cancel</a>
                    </div>
                {% else %}
                <div class="alert alert-warning">
                    <p>No Rule of Credit assigned to this work item's cost code.</p>
                    <p>Please assign a Rule of Credit to the cost code before updating progress.</p>
                </div>
                <div class="mt-4">
                    <a href="{{ url_for('main.view_work_item', work_item_id=work_item.id) }}" class="btn btn-outline-light">Back</a>
                </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>
{% endblock %}

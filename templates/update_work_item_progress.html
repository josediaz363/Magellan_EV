{% extends "base.html" %}

{% block title %}Update Progress - {{ work_item.description }}{% endblock %}

{% block content %}
    <h1>Update Progress for Work Item: {{ work_item.work_item_id_str }}</h1>
    <h2>{{ work_item.description }}</h2>
    <p><strong>Rule of Credit:</strong> {{ work_item.rule_of_credit.name }}</p>

    <form method="POST" action="{{ url_for("main.update_work_item_progress_route", work_item_id=work_item.id) }}">
        <table class="table">
            <thead>
                <tr>
                    <th>Step Name</th>
                    <th>Weight (%)</th>
                    <th>Current % Complete</th>
                    <th>New % Complete</th>
                </tr>
            </thead>
            <tbody>
                {% for step in steps_definition %}
                <tr>
                    <td>{{ step.name }}</td> {# Corrected from step.step_name #}
                    <td>{{ step.weight }}%</td>
                    <td>{{ current_progress.get(step.name, 0) }}%</td> {# Corrected from step.step_name #}
                    <td>
                        {# Corrected name attribute to match routes.py logic and use step.name #}
                        <input type="number" class="form-control" name="progress_{{ step.name|replace(' ', '_')|replace(':', '_')|replace('/', '_') }}" value="{{ current_progress.get(step.name, 0) }}" min="0" max="100" step="any">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="submit" class="btn btn-primary">Update Progress</button>
        <a href="{{ url_for("main.view_project", project_id=work_item.sub_job.project_id) }}" class="btn btn-secondary">Cancel</a> {# Corrected redirect to project view #}
    </form>

    <hr>
    <h3>Current Calculated Values:</h3>
    <p><strong>Budgeted Man Hours:</strong> {{ "%.2f"|format(work_item.budgeted_man_hours) if work_item.budgeted_man_hours is not none else "N/A" }}</p>
    <p><strong>Earned Man Hours:</strong> {{ "%.2f"|format(work_item.earned_man_hours) if work_item.earned_man_hours is not none else "N/A" }}</p>
    <p><strong>% Complete (Hours):</strong> {{ "%.2f"|format(work_item.percent_complete_hours) if work_item.percent_complete_hours is not none else "N/A" }}%</p>
    
    {% if work_item.budgeted_quantity is not none and work_item.budgeted_quantity > 0 %}
    <p><strong>Budgeted Quantity:</strong> {{ "%.2f"|format(work_item.budgeted_quantity) }} {{ work_item.unit_of_measure }}</p>
    <p><strong>Earned Quantity:</strong> {{ "%.2f"|format(work_item.earned_quantity) if work_item.earned_quantity is not none else "N/A" }} {{ work_item.unit_of_measure }}</p>
    <p><strong>% Complete (Quantity):</strong> {{ "%.2f"|format(work_item.percent_complete_quantity) if work_item.percent_complete_quantity is not none else "N/A" }}%</p>
    {% endif %}

{% endblock %}


{% extends 'base.html' %}

{% block title %}Magellan EV - Update Work Item Progress{% endblock %}

{% block page_title %}Update Work Item Progress{% endblock %}

{% block header_actions %}
    <a href="{{ url_for('main.view_work_item', work_item_id=work_item.id) }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Work Item
    </a>
{% endblock %}

{% block content %}
    <div class="form-container">
        <div class="work-item-summary">
            <h3>{{ work_item.description }}</h3>
            <div class="summary-details">
                <div class="summary-item">
                    <span class="label">ID:</span>
                    <span class="value">{{ work_item.work_item_id_str }}</span>
                </div>
                <div class="summary-item">
                    <span class="label">Cost Code:</span>
                    <span class="value">{{ work_item.cost_code.cost_code_id_str if work_item.cost_code else 'N/A' }}</span>
                </div>
                <div class="summary-item">
                    <span class="label">Budgeted Hours:</span>
                    <span class="value">{{ work_item.budgeted_man_hours }}</span>
                </div>
                <div class="summary-item">
                    <span class="label">Earned Hours:</span>
                    <span class="value">{{ work_item.earned_man_hours|round(1) }}</span>
                </div>
                <div class="summary-item">
                    <span class="label">Overall Progress:</span>
                    <span class="value">{{ work_item.percent_complete_hours|round(1) }}%</span>
                </div>
            </div>
        </div>

        <form method="POST" action="{{ url_for('main.update_work_item_progress', work_item_id=work_item.id) }}">
            <div class="progress-form">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Step</th>
                            <th>Weight</th>
                            <th>Current Completion</th>
                            <th>New Completion</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for step in steps %}
                            <tr>
                                <td>{{ step.name }}</td>
                                <td>{{ step.weight }}%</td>
                                <td>{{ progress.get(step.name, 0)|round(1) }}%</td>
                                <td>
                                    <input type="number" name="progress_{{ step.name }}" class="form-control progress-input" 
                                           value="{{ progress.get(step.name, 0)|round(1) }}" min="0" max="100" step="0.1">
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="4" class="text-center">No steps available</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Update Progress</button>
                <a href="{{ url_for('main.view_work_item', work_item_id=work_item.id) }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Validate progress inputs
        const form = document.querySelector('form');
        form.addEventListener('submit', function(event) {
            const inputs = document.querySelectorAll('.progress-input');
            let valid = true;
            
            inputs.forEach(input => {
                const value = parseFloat(input.value);
                if (isNaN(value) || value < 0 || value > 100) {
                    input.classList.add('is-invalid');
                    valid = false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });
            
            if (!valid) {
                event.preventDefault();
                alert('Please ensure all progress values are between 0 and 100.');
            }
        });
    });
</script>
{% endblock %}

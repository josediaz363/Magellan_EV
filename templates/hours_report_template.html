<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hours Report</title>
    <style>
        @page {
            size: letter landscape;
            margin: 1cm;
        }
        body {
            font-family: Arial, sans-serif;
            font-size: 10pt;
            margin: 0;
            padding: 0;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        .header-left {
            width: 20%;
        }
        .header-center {
            width: 60%;
            text-align: center;
        }
        .header-right {
            width: 20%;
            text-align: right;
        }
        .logo {
            height: 50px;
        }
        .report-title {
            font-size: 16pt;
            font-weight: bold;
            margin: 0;
        }
        .report-subtitle {
            font-size: 12pt;
            margin: 5px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .text-right {
            text-align: right;
        }
        .text-center {
            text-align: center;
        }
        .discipline-header {
            background-color: #e6f2ff;
            font-weight: bold;
        }
        .cost-code-header {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .total-row {
            font-weight: bold;
            background-color: #f2f2f2;
        }
        .grand-total-row {
            font-weight: bold;
            background-color: #e6e6e6;
        }
        .rules-of-credit-header {
            background-color: #f2f2f2;
            font-weight: bold;
            text-align: center;
        }
        .rules-of-credit-steps {
            font-size: 8pt;
        }
        .footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            border-top: 1px solid #ddd;
            padding-top: 5px;
            font-size: 8pt;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <img src="{{ url_for('static', filename='images/magellan_logo_white.png') }}" alt="Magellan EV" class="logo">
        </div>
        <div class="header-center">
            <h1 class="report-title">Progress Detail: {{ report_title }}</h1>
            <p class="report-subtitle">{{ report_subtitle }}</p>
        </div>
        <div class="header-right">
            <p>Page: {{ page_number }}</p>
            <p>Progress: {{ "%.1f"|format(overall_progress) }}%</p>
            <p>Date: {{ current_date }}</p>
        </div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Work Item</th>
                <th>Description</th>
                <th>UOM</th>
                <th>Budgeted Hours</th>
                <th>Earned Hours</th>
                <th>% Complete</th>
                <th colspan="7" class="rules-of-credit-header">Rules of Credit</th>
            </tr>
        </thead>
        <tbody>
            {% for discipline, cost_codes in grouped_items.items() %}
                <!-- Discipline Header -->
                <tr class="discipline-header">
                    <td colspan="6">{{ discipline }}</td>
                    <td colspan="7"></td>
                </tr>
                
                {% for cost_code_id, cost_code_data in cost_codes.items() %}
                    <!-- Cost Code Header -->
                    <tr class="cost-code-header">
                        <td colspan="6">{{ cost_code_data.cost_code.cost_code_id_str }} - {{ cost_code_data.cost_code.description }}</td>
                        <td colspan="7"></td>
                    </tr>
                    
                    {% for item in cost_code_data.items %}
                        <tr>
                            <td>{{ item.work_item_id_str }}</td>
                            <td>{{ item.description }}</td>
                            <td>{{ item.unit_of_measure }}</td>
                            <td class="text-right">{{ "%.2f"|format(item.budgeted_man_hours) if item.budgeted_man_hours else "0.00" }}</td>
                            <td class="text-right">{{ "%.2f"|format(item.earned_man_hours) if item.earned_man_hours else "0.00" }}</td>
                            <td class="text-right">{{ "%.1f"|format(item.percent_complete_hours) if item.percent_complete_hours else "0.0" }}%</td>
                            
                            <!-- Rules of Credit Steps -->
                            {% if item.cost_code and item.cost_code.rule_of_credit %}
                                {% set steps = item.cost_code.rule_of_credit.get_steps() %}
                                {% set progress_data = item.get_steps_progress() %}
                                
                                {% for step in steps[:7] %}
                                    <td class="text-center rules-of-credit-steps">
                                        {{ step.name }}: {{ "%.0f"|format(progress_data.get(step.name, 0)) }}%
                                    </td>
                                {% endfor %}
                                
                                <!-- Fill empty cells if less than 7 steps -->
                                {% for _ in range(7 - steps|length) %}
                                    <td></td>
                                {% endfor %}
                            {% else %}
                                <td colspan="7"></td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                    
                    <!-- Cost Code Total -->
                    <tr class="total-row">
                        <td colspan="3">Cost Code Total</td>
                        <td class="text-right">{{ "%.2f"|format(cost_code_data.total_budgeted_hours) }}</td>
                        <td class="text-right">{{ "%.2f"|format(cost_code_data.total_earned_hours) }}</td>
                        <td class="text-right">
                            {% if cost_code_data.total_budgeted_hours > 0 %}
                                {{ "%.1f"|format((cost_code_data.total_earned_hours / cost_code_data.total_budgeted_hours) * 100) }}%
                            {% else %}
                                0.0%
                            {% endif %}
                        </td>
                        <td colspan="7"></td>
                    </tr>
                {% endfor %}
                
                <!-- Discipline Total -->
                <tr class="total-row">
                    <td colspan="3">{{ discipline }} Total</td>
                    <td class="text-right">{{ "%.2f"|format(discipline_totals[discipline].total_budgeted_hours) }}</td>
                    <td class="text-right">{{ "%.2f"|format(discipline_totals[discipline].total_earned_hours) }}</td>
                    <td class="text-right">
                        {% if discipline_totals[discipline].total_budgeted_hours > 0 %}
                            {{ "%.1f"|format((discipline_totals[discipline].total_earned_hours / discipline_totals[discipline].total_budgeted_hours) * 100) }}%
                        {% else %}
                            0.0%
                        {% endif %}
                    </td>
                    <td colspan="7"></td>
                </tr>
            {% endfor %}
            
            <!-- Grand Total -->
            <tr class="grand-total-row">
                <td colspan="3">Grand Total</td>
                <td class="text-right">{{ "%.2f"|format(total_budgeted_hours) }}</td>
                <td class="text-right">{{ "%.2f"|format(total_earned_hours) }}</td>
                <td class="text-right">{{ "%.1f"|format(overall_progress) }}%</td>
                <td colspan="7"></td>
            </tr>
        </tbody>
    </table>
    
    <div class="footer">
        <p>Generated by Magellan EV Tracker on {{ current_date }}</p>
    </div>
</body>
</html>

{% extends "base.html" %}

{% block title %}Reports - Magellan EV Tracker{% endblock %}

{% block page_title %}Reports{% endblock %}

{% block content %}
<div class="reports-container">
    <div class="card">
        <div class="card-header">
            <h2>Export Reports</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col">
                    <h3>Project Reports</h3>
                    <form action="{{ url_for('main.export_project_report') }}" method="get" class="mb-4">
                        <div class="form-group mb-3">
                            <label for="project_id">Select Project:</label>
                            <select name="project_id" id="project_id" class="form-control" required>
                                <option value="">-- Select Project --</option>
                                {% for project in projects %}
                                <option value="{{ project.id }}">{{ project.name }} ({{ project.project_id_str }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group mb-3">
                            <label>Report Type:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="report_type" id="quantities_project" value="quantities" checked>
                                <label class="form-check-label" for="quantities_project">
                                    Quantities Report
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="report_type" id="hours_project" value="hours">
                                <label class="form-check-label" for="hours_project">
                                    Hours Report
                                </label>
                            </div>
                        </div>
                        <div class="form-group mb-3">
                            <label>Export Format:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="format" id="pdf_project" value="pdf" checked>
                                <label class="form-check-label" for="pdf_project">
                                    PDF
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="format" id="excel_project" value="excel">
                                <label class="form-check-label" for="excel_project">
                                    Excel
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Export Project Report</button>
                    </form>
                </div>
                <div class="col">
                    <h3>Sub Job Reports</h3>
                    <form action="{{ url_for('main.export_sub_job_report') }}" method="get" class="mb-4">
                        <div class="form-group mb-3">
                            <label for="project_id_sub_job">Select Project:</label>
                            <select name="project_id" id="project_id_sub_job" class="form-control" required>
                                <option value="">-- Select Project --</option>
                                {% for project in projects %}
                                <option value="{{ project.id }}">{{ project.name }} ({{ project.project_id_str }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group mb-3">
                            <label for="sub_job_id">Select Sub Job:</label>
                            <select name="sub_job_id" id="sub_job_id" class="form-control" required disabled>
                                <option value="">-- Select Project First --</option>
                            </select>
                        </div>
                        <div class="form-group mb-3">
                            <label>Report Type:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="report_type" id="quantities_sub_job" value="quantities" checked>
                                <label class="form-check-label" for="quantities_sub_job">
                                    Quantities Report
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="report_type" id="hours_sub_job" value="hours">
                                <label class="form-check-label" for="hours_sub_job">
                                    Hours Report
                                </label>
                            </div>
                        </div>
                        <div class="form-group mb-3">
                            <label>Export Format:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="format" id="pdf_sub_job" value="pdf" checked>
                                <label class="form-check-label" for="pdf_sub_job">
                                    PDF
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="format" id="excel_sub_job" value="excel">
                                <label class="form-check-label" for="excel_sub_job">
                                    Excel
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Export Sub Job Report</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Populate sub jobs dropdown when project is selected
    document.getElementById('project_id_sub_job').addEventListener('change', function() {
        const projectId = this.value;
        const subJobSelect = document.getElementById('sub_job_id');
        
        if (projectId) {
            // Enable sub job select
            subJobSelect.disabled = false;
            
            // Clear current options
            subJobSelect.innerHTML = '<option value="">-- Loading Sub Jobs --</option>';
            
            // Fetch sub jobs for selected project
            fetch(`/api/get_sub_jobs/${projectId}`)
                .then(response => response.json())
                .then(data => {
                    subJobSelect.innerHTML = '<option value="">-- Select Sub Job --</option>';
                    data.forEach(subJob => {
                        const option = document.createElement('option');
                        option.value = subJob.id;
                        option.textContent = subJob.name;
                        subJobSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching sub jobs:', error);
                    subJobSelect.innerHTML = '<option value="">-- Error Loading Sub Jobs --</option>';
                });
        } else {
            // Disable and reset sub job select
            subJobSelect.disabled = true;
            subJobSelect.innerHTML = '<option value="">-- Select Project First --</option>';
        }
    });
</script>
{% endblock %}
